name: "Run Evidently Report"
description: "Run Evidently CLI report with flexible local/cloud output and smart result linking"
author: "Mikhail Sveshnikov"

branding:
  icon: check-square
  color: "red"

inputs:
  config_path:
    description: "Report configuration path"
    required: true
  input_path:
    description: "Input dataset URI"
    required: false
  reference_path:
    description: "Reference dataset URI"
    required: false
  output:
    description: "Output URI"
    required: false
  dataset_name:
    description: "Dataset name"
    required: false
  test_summary:
    description: "Run tests summary"
    required: false
    default: "true"
  save_dataset:
    description: "Save output dataset"
    required: false
    default: "true"
  save_report:
    description: "Save output report"
    required: false
    default: "true"
  project_id:
    description: "Evidently Cloud project ID"
    required: false
  dataset_id:
    description: "Evidently Cloud dataset ID"
    required: false
  base_url:
    description: "Evidently Cloud base URL"
    required: false
    default: "app.evidently.cloud"
  upload_artifacts:
    description: "Upload result files as GHA artifacts"
    required: false
    default: "false"
  api_key:
    description: "Evidently API Key"
    required: false
  use_pip_cache:
    description: 'Use pip cache'
    required: false
    default: 'true'
  check-link:
    description: "Whether to post a check run with an external link"
    required: false
    default: "true"

outputs:
  exit_code:
    description: "Exit code of the Evidently CLI run"
    value: ${{ steps.run-cli.outputs.exit_code }}
  found_link:
    description: "Report snapshot link, if found"
    value: ${{ steps.extract-link.outputs.found_link }}

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4

    - name: Check if actions/setup-python has run
      id: check-python-setup
      run: |
        if [ -n "$pythonLocation" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - uses: actions/setup-python@v5
      if: steps.check-python-setup.outputs.exists == 'false'
      with:
        python-version: "3.12"

    - name: Cache pip dependencies
      if: ${{ inputs.use_pip_cache == 'true' }}
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      shell: bash
      run: pip install git+https://github.com/evidentlyai/evidently@feature/eval-cli

    - name: Build input and output URIs
      id: build-uris
      shell: bash
      run: |
        INPUT="${{ inputs.input_path }}"
        OUTPUT="${{ inputs.output }}"
        SHA="${{ github.sha }}"

        if [ -n "${{ inputs.dataset_id }}" ]; then
          INPUT="cloud://${{ inputs.base_url }}/${{ inputs.dataset_id }}"
        fi

        if [ -n "${{ inputs.project_id }}" ]; then
          OUTPUT="cloud://${{ inputs.base_url }}/${{ inputs.project_id }}"
        fi

        if [ -z "$OUTPUT" ]; then
          OUTPUT="evidently_report_$SHA"
        fi

        echo "input=$INPUT" >> $GITHUB_OUTPUT
        echo "output=$OUTPUT" >> $GITHUB_OUTPUT

    - name: Run Evidently CLI Report
      id: run-cli
      shell: bash
      continue-on-error: true
      env:
        EVIDENTLY_API_KEY: ${{ inputs.api_key }}
        FORCE_COLOR: "1"
      run: |
        set +o pipefail
        evidently report \
          ${{ inputs.config_path }} \
          "${{ steps.build-uris.outputs.input }}" \
          "${{ steps.build-uris.outputs.output }}" \
          $( [ -n "${{ inputs.reference_path }}" ] && echo "--reference-path ${{ inputs.reference_path }}" ) \
          $( [ -n "${{ inputs.dataset_name }}" ] && echo "--dataset-name ${{ inputs.dataset_name }}" ) \
          $( [ "${{ inputs.test_summary }}" = "true" ] && echo "--test-summary" ) \
          $( [ "${{ inputs.save_dataset }}" = "false" ] && echo "--no-save-dataset" ) \
          $( [ "${{ inputs.save_report }}" = "false" ] && echo "--no-save-report" ) | tee output.log
      
        CLI_EXIT_CODE=${PIPESTATUS[0]}
        echo "exit_code=$CLI_EXIT_CODE" >> $GITHUB_OUTPUT

    - name: Extract report link from CLI output
      id: extract-link
      shell: bash
      run: |
        LINK=$(grep -oE 'Saving (snapshot|dataset) to (http[s]?://[^ ]+)' output.log | head -n1 | sed -E 's/Saving (snapshot|dataset) to //') || true
        echo "found_link=$LINK" >> $GITHUB_OUTPUT

    - name: Post result link or upload artifacts
      shell: bash
      if: ${{ steps.extract-link.outputs.found_link != '' }}
      run: |
        echo "::notice title=Evidently Report Link::${{ steps.extract-link.outputs.found_link }}"

    - name: Upload result artifacts
      if: ${{ inputs.upload_artifacts == 'true' && steps.extract-link.outputs.found_link == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: evidently-results
        path: ${{ steps.build-uris.outputs.output }}

    - name: Check permissions for GITHUB_TOKEN
      if: ${{ inputs.check-link == 'true' }}
      id: permissions
      shell: bash
      run: |
        PERMISSIONS_RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
          https://api.github.com/repos/${{ github.repository }}/actions/permissions)
        
        CHECKS_PERMISSION=$(echo "$PERMISSIONS_RESPONSE" | jq -r '.permissions.checks')
        
        if [ "$CHECKS_PERMISSION" = "write" ]; then
          echo "checks_write=true" >> "$GITHUB_OUTPUT"
        else
          echo "checks_write=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Post Check Run with external link
      if: ${{ inputs.check-link == 'true' && steps.permissions.outputs.checks_write == 'true' && steps.extract-link.outputs.found_link != '' }}
      shell: bash
      run: |
        curl -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/check-runs \
          -d '{
            "name": "Evidently Report",
            "head_sha": "'${{ github.sha }}'",
            "status": "completed",
            "conclusion": "success",
            "external_url": "${{ steps.extract-link.outputs.found_link }}", 
            "output": {
              "title": "External Report Ready",
              "summary": "View the external link for details."
            }
          }'

    - name: Warn if insufficient permissions
      if: ${{ inputs.check-link == 'true' && steps.permissions.outputs.checks_write != 'true' && steps.extract-link.outputs.found_link != ''}}
      shell: bash
      run: |
        echo "::warning title=Permissions Issue::GITHUB_TOKEN lacks 'checks: write' permission. Skipping external check run."

    - name: Fail action if CLI failed
      if: steps.run-cli.outputs.exit_code != '0'
      shell: bash
      run: |
        echo "‚ùå Evidently CLI failed with exit code ${{ steps.run-cli.outputs.exit_code }}"
        exit 1
